import{H as T,r as f,c as p,s as z,z as D}from"./vue-vendor-DBH4gaed.js";import{s as m,a as M}from"./services-B6m35qR1.js";const L=T("auth",()=>{const s=f(null),a=f(null),o=f(!1),n=f(null),v=f(!1),i=f(null),S=f(!1);let w=null;const U=p(()=>!!s.value&&!!a.value),A=p(()=>!!n.value&&n.value.is_active),c=p(()=>{if(!a.value)return!1;const e=Math.floor(Date.now()/1e3);return a.value.expires_at?a.value.expires_at>e:!0}),b=async()=>{if(!v.value){o.value=!0,S.value=!1;try{const{data:{session:e},error:r}=await m.auth.getSession();if(r){console.error("Session retrieval error:",r),await l();return}if(e){if(a.value=e,s.value=e.user,!c.value){console.log("Session expired, clearing auth state"),await l();return}if(!await y()){console.log("User is not an admin, signing out"),await g();return}}w&&w.data.subscription.unsubscribe(),w=m.auth.onAuthStateChange(async(u,d)=>{var I;if(console.log("Auth state change:",u,(I=d==null?void 0:d.user)==null?void 0:I.email),u==="SIGNED_OUT"){a.value=null,s.value=null,n.value=null,S.value=!1,console.log("User signed out, cleared auth state");return}if(u==="TOKEN_REFRESHED"&&console.log("Token refreshed, updating session"),u==="SIGNED_IN"||u==="TOKEN_REFRESHED")if(a.value=d,s.value=(d==null?void 0:d.user)||null,d!=null&&d.user){if(!await y()){console.log("User does not have admin privileges, signing out"),await g();return}console.log("Auth state updated successfully")}else n.value=null}),v.value=!0}catch(e){console.error("Auth initialization error:",e),await l()}finally{o.value=!1}}},l=async()=>{S.value=!0,a.value=null,s.value=null,n.value=null;try{await m.auth.signOut()}catch(e){console.error("Error during session cleanup:",e)}},E=e=>{i.value=e;try{sessionStorage.setItem("auth-redirect-url",e)}catch(r){console.warn("Failed to store redirect URL:",r)}},P=()=>{let e=i.value||"/dashboard";if(!i.value)try{const r=sessionStorage.getItem("auth-redirect-url");r&&(e=r)}catch(r){console.warn("Failed to retrieve redirect URL:",r)}i.value=null;try{sessionStorage.removeItem("auth-redirect-url")}catch(r){console.warn("Failed to clear redirect URL:",r)}return e},y=async()=>{if(!s.value)return!1;try{const{data:e,error:r}=await M.from("admin_users").select("*").eq("email",s.value.email).eq("is_active",!0).single();if(r&&r.code!=="PGRST116")throw r;return n.value=e,!!e}catch(e){return console.error("Admin status check error:",e),n.value=null,!1}},R=async(e,r)=>{o.value=!0;try{const{data:u,error:d}=await m.auth.signInWithPassword({email:e,password:r});if(d)throw d;if(u.user&&u.session){if(a.value=u.session,s.value=u.user,S.value=!1,await new Promise(O=>setTimeout(O,300)),!await y())throw await g(),new Error("Access denied. Admin privileges required.");if(!U.value||!A.value)throw console.error("Auth state not properly set after login"),await g(),new Error("Authentication state error. Please try again.");return console.log("Successfully signed in!"),{success:!0}}else throw new Error("No user data returned from authentication")}catch(u){return console.error("Sign in failed:",u.message),{success:!1,error:u.message}}finally{o.value=!1}},g=async()=>{o.value=!0;try{const{error:e}=await m.auth.signOut();if(e)throw e;s.value=null,a.value=null,n.value=null,console.log("Successfully signed out!")}catch(e){console.error("Sign out failed:",e.message)}finally{o.value=!1}};return{user:s,session:a,adminUser:n,loading:o,initialized:v,redirectUrl:i,sessionExpired:S,isAuthenticated:U,isAdmin:A,hasValidSession:c,initialize:b,signIn:R,signOut:g,resetPassword:async e=>{o.value=!0;try{const{error:r}=await m.auth.resetPasswordForEmail(e);if(r)throw r;return console.log("Password reset email sent!"),{success:!0}}catch(r){return console.error("Password reset failed:",r.message),{success:!1,error:r.message}}finally{o.value=!1}},updatePassword:async e=>{o.value=!0;try{const{error:r}=await m.auth.updateUser({password:e});if(r)throw r;return console.log("Password updated successfully!"),{success:!0}}catch(r){return console.error("Password update failed:",r.message),{success:!1,error:r.message}}finally{o.value=!1}},checkAdminStatus:y,handleSessionExpiration:l,setRedirectUrl:E,getAndClearRedirectUrl:P,refreshSession:async()=>{try{console.log("ðŸ”„ Manually refreshing session...");const{data:e,error:r}=await m.auth.refreshSession();return r?(console.error("Session refresh failed:",r),await l(),!1):e.session?(a.value=e.session,s.value=e.session.user,console.log("âœ… Session refreshed successfully"),!0):!1}catch(e){return console.error("Session refresh error:",e),await l(),!1}},recoverConnection:async()=>{try{console.log("ðŸ”„ Attempting connection recovery...");const{data:{session:e},error:r}=await m.auth.getSession();return r?(console.error("Session recovery failed:",r),await l(),!1):e?c.value?(a.value=e,s.value=e.user,await y()?(await z(),console.log("âœ… Connection recovered successfully"),!0):(console.log("Admin status lost during recovery"),await g(),!1)):(console.log("Session expired during recovery"),await l(),!1):(console.log("No session found during recovery"),await l(),!1)}catch(e){return console.error("Connection recovery failed:",e),await l(),!1}},validateSession:async()=>{if(!a.value||!s.value)return!1;try{return c.value?await y()?!0:(console.log("Session validation failed: not admin"),await g(),!1):(console.log("Session validation failed: expired"),await l(),!1)}catch(e){return console.error("Session validation error:",e),await l(),!1}},cleanup:()=>{w&&(w.data.subscription.unsubscribe(),w=null),v.value=!1}}}),x="petsmart-admin-sidebar-state",q=T("sidebar",()=>{const s=f(!0),a=f(!1),o=f(0),n=f(""),v=f(!1),i=f({autoCollapse:!1,rememberScrollPosition:!0,persistState:!0}),S=p(()=>s.value&&!a.value),w=p(()=>a.value),U=p(()=>!s.value),A=()=>{try{const t=localStorage.getItem(x);if(t)return JSON.parse(t)}catch(t){console.warn("Failed to load sidebar state from localStorage:",t)}return null},c=()=>{if(i.value.persistState)try{const t={drawer:s.value,rail:a.value,scrollPosition:o.value,lastActiveRoute:n.value,userPreferences:i.value};localStorage.setItem(x,JSON.stringify(t))}catch(t){console.warn("Failed to save sidebar state to localStorage:",t)}},b=t=>{const h=A();if(h&&h.userPreferences.persistState)s.value=h.drawer,a.value=h.rail,o.value=h.scrollPosition||0,n.value=h.lastActiveRoute||"",i.value={...i.value,...h.userPreferences};else{const e=t<=768;s.value=!e,a.value=!1,o.value=0}v.value=!0},l=t=>{s.value=t,c()},E=()=>{l(!s.value)},P=t=>{a.value=t,c()},y=()=>{P(!a.value)},R=t=>{i.value.rememberScrollPosition&&(o.value=t,c())},g=t=>{n.value=t,c()},C=t=>{i.value={...i.value,...t},c()},_=t=>{t<=768?(s.value&&l(!1),a.value&&P(!1)):!s.value&&v.value&&l(!0)},F=()=>{s.value=!0,a.value=!1,o.value=0,n.value="",i.value={autoCollapse:!1,rememberScrollPosition:!0,persistState:!0},c()},N=()=>{try{localStorage.removeItem(x)}catch(t){console.warn("Failed to clear sidebar state from localStorage:",t)}};return D([s,a],()=>{v.value&&c()}),{drawer:s,rail:a,scrollPosition:o,lastActiveRoute:n,userPreferences:i,isInitialized:v,isExpanded:S,isCollapsed:w,isClosed:U,initialize:b,setDrawer:l,toggleDrawer:E,setRail:P,toggleRail:y,setScrollPosition:R,setLastActiveRoute:g,updatePreferences:C,handleResize:_,reset:F,clearStoredState:N,saveState:c,loadState:A}});export{q as a,L as u};
//# sourceMappingURL=stores-BYixwwI5.js.map
